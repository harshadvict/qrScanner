<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://rawgit.com/schmich/instascan-builds/master/instascan.min.js"></script>
    <title>Document</title>
    <style>
        #scanner-container {
            margin: auto;
            width: 60%;
            border: 2px solid #333232;
            padding: 10px;
        }

        .btn-pos {
            margin-top: 10px;
        }
    </style>
</head>

<body>
    <!-- to do:-- add box outside the scanner
    integrate to send event to the bot
    to add start scanning button
    on selecting start need to start the scanner
    update the ui to make teh scanner responsive -->

    <div id="scanner-container">
        <video id="preview" width="100%" height="70%" style="display: none;"></video>
        <div width="50%" height="50%" style="margin-left: 25%;">
            <div>
                <img src="https://cdn.yellowmessenger.com/UsSib5l6dMqH1640790771328.svg" id="scan-img" alt="image"
                    width="70%" height="50%">
            </div>
            <button id="start-btn" class="btn-pos" onclick="startScanner();">
                Start scanning
            </button>
            <button id="stop-btn" class="btn-pos" onclick="stopScanner();" style="display: none;">
                Stop scanning
            </button>
        </div>
    </div>
    <script type="text/javascript">
        let scannerTimeout;
        let opts = {
            continuous: true,
            video: document.getElementById('preview'),
            mirror: true,
            captureImage: false,
            backgroundScan: false,
            refractoryPeriod: 5000,
            scanPeriod: 1
        };
        let scannerTimer = (option) => {
            if (option == 'STOP') {
                clearTimeout(scannerTimeout);
            } else {
                scannerTimeout = setTimeout(() => {
                    document.getElementById('preview').style.display = 'none';
                    document.getElementById('stop-btn').style.display = 'none';
                    document.getElementById('start-btn').style.display = 'block';
                    document.getElementById('scan-img').style.display = 'block';
                    scanner.stop().then(() => {
                        console.log('camera close due to timeout');
                    })
                }, 500000);
            }
        }
        formatQrData = async (dataFromQr) => {
            let splittedData = dataFromQr.split("|")
            console.log(splittedData, 'splittedData')
            let finalDataToBeSend = [];
            await splittedData.forEach(element => {
                element.slice(1,-1);
                element.trim()
                let splitData = element.split(":");
                var obj = {};
                obj[splitData[0].trim()] = splitData[1].trim();
                finalDataToBeSend.push(obj);
            });
            console.log(finalDataToBeSend,'finalDataToBeSend')
        }
        let scanner = new Instascan.Scanner(opts, {
            video: document.getElementById('preview')
        });
        scanner.addListener('scan', function (content) {
            console.log(content);
            scanner.stop().then(() => {
                clearTimeout(scannerTimeout);
                document.getElementById('preview').style.display = 'none';
                document.getElementById('stop-btn').style.display = 'none';
                console.log('your content', content);
                const div = document.getElementById("scanner-container");
                console.log(typeof content)
                div.innerHTML = content;
                formatQrData(content); //pasing data to format
            })
        });
        scanner.addListener('active', function () {
            console.log('active');
        })
        scanner.addListener('inactive', function () {
            console.log('inactive');
        })
        startScanner = () => {
            //to handle the case when user start scanning
            document.getElementById('preview').style.display = 'block';
            document.getElementById('stop-btn').style.display = 'block';
            document.getElementById('start-btn').style.display = 'none';
            document.getElementById('scan-img').style.display = 'none';
            Instascan.Camera.getCameras().then(function (cameras) {
                console.log(cameras, 'cameras')
                if (cameras.length > 0) {
                    scanner.start(cameras[0]).then(() => {
                        scannerTimer('START');
                        let result = scanner.scan()
                        console.log(result, 'result')
                    }).catch(() => {
                        console.error('camera not started');
                    });
                } else {
                    console.error('No cameras found.');
                }
            }).catch(function (e) {
                console.log(e);
            });
        }

        stopScanner = () => {
            //to handle the case when user stopped scanning
            document.getElementById('preview').style.display = 'none';
            document.getElementById('stop-btn').style.display = 'none';
            document.getElementById('start-btn').style.display = 'block';
            document.getElementById('scan-img').style.display = 'block';
            scanner.stop().then(() => {
                console.log('user close the camera');
            })
        }
    </script>
</body>

</html>
